import { TargetRegion } from './types';

// ▼ 1. ジャンルリスト
export const GENRE_LIST = [
  "「マンガでわかる」・解説学習系",
  "恋愛・人間ドラマ系",
  "ライフハック・自己成長・教育系",
  "マネー・経済・キャリア系",
  "AI・テクノロジー系（2025年トレンド）",
  "ライト文芸・ストーリー系",
  "実用系・ノウハウ系",
  "ビジネス・起業ストーリー系",
  "実話ベース・ドキュメンタリー系",
  "美容・健康・ライフスタイル系",
  "クリエイター・アート系",
  "パーソナルストーリー・半自伝系",
  "SNS向けショート系",
  "アクション・アドベンチャー",
  "ミーム・ユーモア・風刺",
  "古典文学・名作リメイク",
];

// ▼ 2. 実用・解説系ジャンルの判定ロジック（強化版）
// 「ビジネス」が含まれていても、「ストーリー」なら物語として扱うよう優先順位を設定
const isPracticalGenre = (genre: string): boolean => {
  const STORY_KEYWORDS = ["ストーリー", "物語", "ドラマ", "文芸", "冒険", "ファンタジー", "ドキュメンタリー", "伝記", "自伝", "リメイク", "ショート", "ミーム"];
  // 1. ストーリー系キーワードが含まれていれば、強制的に「物語モード」にする
  if (STORY_KEYWORDS.some(k => genre.includes(k))) return false;
  
  const PRACTICAL_KEYWORDS = ["マンガでわかる", "解説", "学習", "ビジネス", "ノウハウ", "実用", "入門", "ライフハック", "AI", "マネー", "経済", "健康", "教育", "クリエイター"];
  // 2. それ以外で実用系キーワードが含まれていれば「解説本モード」にする
  return PRACTICAL_KEYWORDS.some(k => genre.includes(k));
};

const getRegionContext = (region: TargetRegion) => {
  return region === 'domestic' 
    ? { 
        name: '日本国内', 
        market: '日本国内市場', 
        audience: '日本の読者', 
        crossBorder: '海外（特に英語圏）で流行し始めているが、まだ日本で定着していないトレンドのローカライズを検討してください。',
        admonition: '日本の社会背景（少子高齢化、将来不安、推し活、タイパ重視）と、SNS上の本音（建前ではない悩み）を踏まえて分析してください。',
        subjectPrefix: '日本国内では',
        namingPolicy: '現代的で実在感のある日本人のフルネーム（苗字と名前）を設定してください。キラキラネームではなく、その職業や年齢にふさわしい信頼感のある名前（例：佐藤 健斗、小林 芽依など）を選んでください。'
      }
    : { 
        name: '英語圏（特に北米）', 
        market: '英語圏（特に北米）の市場', 
        audience: '英語圏の読者（北米中心）', 
        crossBorder: '「日本の漫画」では一般的だが、英語圏ではまだ未開拓なテーマ（例：特定の専門職やニッチな趣味の教育マンガ "Graphic Guides"）を検討してください。',
        admonition: '重要: 日本独自の概念（偏差値、先輩後輩、新卒一括採用など）は避け、現地の文化背景（Gen Z, Millennials, FIREなど）やトレンド用語（Gen Z, Millennials, FIRE）の「現地での文脈」に合わせて分析してください。',
        subjectPrefix: '北米・英語圏市場では',
        namingPolicy: '多様な文化的背景（ヒスパニック、アジア、アフリカ系、ヨーロッパ系など）を反映した、現代的な英語圏の名前（First Name + Last Name）を設定してください。Elena, Mateo, Priya, Jordan, Marcus, Kenji などの個性を感じさせる名前を採用してください。'
      };
};

/**
 * ■ Step 1: ジャンル提案プロンプト
 * 市場の「空き」を見つける際、実用と物語の両方の視点（悩み or 感情）を含めて探索させます。
 */
export const getGenreProposalPrompt = (region: TargetRegion) => {
  const ctx = getRegionContext(region);
  return `
あなたは「${ctx.market}専門のデータドリブン・マンガトレンドアナリスト」です。
現在の${ctx.market}において、**「需要は爆発しているが、供給（決定版となるマンガ）が追いついていない」**ブルーオーシャンなジャンルを5つ特定してください。

# ターゲット市場と分析方針
- **対象市場**: ${ctx.market}
- **文脈**: ${ctx.admonition}

# 思考・検証プロセス（以下のフィルタリングを経て選定すること）
1. **Trend (認知)**: SNSや検索トレンドで上昇傾向にあり、一過性ではないテーマか？
2. **Deep Need (深度)**: 
   - 【実用系なら】YouTubeや知恵袋で「深い悩み」や「解決策」が必死に探されているか？
   - 【物語系なら】読者が「特定の感情（スカッと、尊い、恐怖）」を強く求めているか？
3. **Gap (空白)**: 活字本や動画はあるが、**「マンガ」という形式での決定版がまだない**領域か？

# 出力形式の厳守事項
- **冒頭の挨拶は一切不要です。** いきなり1つ目の提案から書き始めてください。
- 5つのジャンルを提案してください。
- 各ジャンルの間には、必ず **\`---SECTION_SPLIT---\`** を入れてください。

# 出力フォーマット
1. **ジャンル名**：【市場の痛み/欲求】...【なぜ今マンガなのか(競合分析)】...
---SECTION_SPLIT---
...
`;
};

/**
 * ■ Step 2: テーマ・タイトル提案プロンプト
 * ここで「実用」か「物語」かによってプロンプトを完全に切り替えます。
 */
export const getTopicProposalPrompt = (genre: string, keyword: string | undefined, region: TargetRegion) => {
  const ctx = getRegionContext(region);
  const isPractical = isPracticalGenre(genre);
  
  // キーワード指定がある場合の制約
  const keywordConstraint = keyword 
    ? `\n# 最優先事項：指定テーマの書籍化
ユーザーは**「${keyword}」**をテーマにした作品を作りたいと考えています。
提案する5つのうち3つ以上は、必ずタイトルに「${keyword}」を含めてください。
実在ツール（Gemini 3.0, Manus等）の場合は、機能説明ではなく「それを使って何が得られるか（利益、時短）」に焦点を当ててください。`
    : "";

  // ▼ A. 実用系（解説・ノウハウ）の場合の指示
  const practicalPrompt = `
あなたはAmazonランキング1位を連発する「天才ブックプロデューサー」です。
**「${genre}」**というジャンルにおいて、読者が表紙を見た瞬間に購入を決める強力なマンガ企画を5つ提案してください。

# 思考プロセス：3段階の厳格なフィルタリング
1. **Trend**: ${ctx.market}で現在話題になっているキーワードか？
2. **Deep Pain**: 知恵袋やYouTube検索で、人々が「お金を払ってでも解決したい」と思っている悩みか？
3. **Market Gap**: 活字の専門書は売れているが、**「わかりやすいマンガ解説本」**がまだ存在しない領域か？

# 売れるタイトルの絶対法則（以下の型を使用すること）
1. **【ベネフィット直球型】**: "マンガでわかる○○" "見るだけノート" "知識ゼロから3日で〜"（効果を約束する）
2. **【ギャップ・意外性型】**: "がんばらない○○" "文系でもわかる○○"（心理的ハードルを下げる）
3. **【恐怖・損失回避型】**: "9割が間違っている○○" "〜してはいけない"（危機感を煽る）
`;

  // ▼ B. 物語系（ストーリー・エンタメ）の場合の指示
  const storyPrompt = `
あなたはヒット作を量産する「Webtoon/マンガ編集長」です。
**「${genre}」**というジャンルにおいて、読者が熱狂し、続きを読みたくなるマンガ企画を5つ提案してください。

# 思考プロセス：感情と設定の分析
1. **Trope (流行設定)**: ${ctx.market}のランキング上位作品（Webtoon/なろう系/Kindle）で人気のタグは何か？
2. **Twist (ずらし)**: 王道設定にどのような「ひねり」を加えれば差別化できるか？（例：職業、性格、舞台のずらし）
3. **Emotion (カタルシス)**: 読者は「スカッと」「尊い」「ハラハラ」のどの感情を求めているか？

# 売れるタイトルの絶対法則（以下の型を使用すること）
1. **【長文あらすじ型】**: タイトルだけで設定と結末を説明する（例：「〜だと思っていたら実は〜でした」「〜ので最強を目指します」）
2. **【対立・矛盾型】**: 相反する言葉を組み合わせる（例：「魔王なのに〜」「余命半年だけど〜」）
3. **【目的提示型】**: 主人公の強烈な目的を示す（例：「復讐のために〜」「〜して成り上がる」）
`;

  return `
${isPractical ? practicalPrompt : storyPrompt}

# 前提条件
- **Target Market**: ${ctx.market}
- **Analysis Context**: ${ctx.admonition}
${keywordConstraint}

# 出力形式
- 各提案の間に **\`---SECTION_SPLIT---\`** を入れてください。
- 冒頭の挨拶は不要です。

# 出力テンプレート
1. **タイトル案**: [メインタイトル] 〜[サブタイトル]〜
2. **ターゲットの渇望**: [Before: どんな悩み(Pain)または退屈を抱えているか]
3. **企画の勝ち筋**: [After: 読後どうなれるか / 競合との差別化ポイント]
4. **採用した型**: [使用したタイトルの型名]
`;
};

/**
 * ■ Step 3: 詳細構成プロンプト
 * 構成も「カリキュラム」か「ストーリー構成」かをAIに判断させて作成します。
 */
export const getConceptPrompt = (topic: string, region: TargetRegion) => {
  const ctx = getRegionContext(region);
  
  return `
Role: あなたは「グローバル・ベストセラー・プロデューサー」兼「シリーズ構成の達人」です。
Gemini 3.0の能力を駆使し、シリーズ累計100万部を狙える全5巻のマンガ構成案を作成します。

# 対象企画
${topic}

# Target Market
- ${ctx.market}
- ${ctx.admonition}

# キャラクター・ネーミング方針（厳守）
- **名前の多様性**: ${ctx.namingPolicy}
- **禁止事項**: "Alex"のようなありふれた名前は禁止。${ctx.market}で信頼感や親近感を持たれる具体的な名前を設定してください。

---

### 🧠 Phase 2: High-Density Structuring (構成作成)

全5巻分の詳細な構成案を作成してください。
**まず、この作品が「実用・解説マンガ」か「物語・エンタメマンガ」かを判断し、適切な構成ロジックを採用してください。**

**A. 実用・解説マンガの場合（黄金の5巻ロードマップ）**
   * Vol.1: 【拒絶の突破】「私には無理」を解除し、最初の成功体験(Small Win)を与える。
   * Vol.2: 【原則】よくある挫折ポイントを回避し、基礎を固める。
   * Vol.3: 【構造】応用力と本質の理解。
   * Vol.4: 【実践】現場レベルでの活用・連携。
   * Vol.5: 【変革】プロへの到達と大きな成果。

**B. 物語・エンタメマンガの場合（ストーリーアーク）**
   * Vol.1: 【発端】日常の崩壊と冒険への旅立ち（Inciting Incident）。
   * Vol.2: 【試練】敵対者との遭遇、敗北、または能力の覚醒。
   * Vol.3: 【転換】物語の核心に触れる（Midpoint）、大きなひねり。
   * Vol.4: 【絶望】最大の危機（All Is Lost）、クライマックスへの助走。
   * Vol.5: 【解決】最終決戦と新たな日常（Resolution）。

**⚠️ 重要ルール**
1. **章番号のリセット**: 各巻（Vol.1〜Vol.5）ごとに、章番号を **「Chapter 1」からリセット** してください。
2. **描写のバランス**: 実用系なら「マンガ＋図解」、物語系なら「シーン＋心理描写」を具体的に書いてください。

---

### 📝 Output Format (出力形式)

#### ■ 1. 企画分析レポート
* **形式判定**: [実用解説 or ストーリー]
* **勝算の根拠**: [ターゲットの痛み/欲求]と[市場の空き地]の分析

#### ■ 2. シリーズ構成案 (The Master Plan)
**シリーズタイトル**: [確定タイトル]
**コンセプト**: [一言でいうと何の本か]

---

### 【Vol.1: [サブタイトル]】
**コンセプト**: [この巻のゴール]

**Chapter 1: [章タイトル]**
* **マンガ**: [主人公の名前（${ctx.namingPolicy}）を使い、具体的な展開を記述]
* **解説/学習ポイント**: [実用系ならノウハウ、物語系なら伏線や感情の動き]

... (Vol.5まで同様)

---

# シリーズマスターシート
レポートの最後に、以下のフォーマットで「シリーズマスターシート」を必ず出力してください。

--- [SERIES MASTER SHEET: START] ---
【基本設定】
- タイトル: [確定タイトル]
- ジャンル形式: [実用解説 / ストーリー]
- 全体構成: 全5巻

【主人公 (Hero/Heroine)】
- 名前: [フルネーム]
- 属性: [職業・役割]
- Start地点: [当初の悩み・状況]
- Goal地点: [最終的な姿]

【構成進行表】
- Vol.1: [タイトル]
- Vol.2: [タイトル]
- Vol.3: [タイトル]
- Vol.4: [タイトル]
- Vol.5: [タイトル]
--- [SERIES MASTER SHEET: END] ---
`;
};

// Step 4: マスタシート抽出（共通）
export const getMasterSheetOnlyPrompt = (concept: string) => `
あなたは「シリーズ構成作家」です。
以下の企画案を分析し、キャラクター名などが整理された「シリーズマスターシート」のみを出力してください。

# 既存の企画案
${concept}

--- [SERIES MASTER SHEET: START] ---
【基本設定】
- タイトル: [企画案から抽出]
- ジャンル形式: [実用解説 / ストーリー]
- 全体構成: 全5巻

【主人公】
- 名前: [名前]
- 属性: [職業・役割]
- Start地点: [当初の悩み]
- Goal地点: [最終的な姿]

【構成進行表】
- Vol.1: [タイトル]
- Vol.2: [タイトル]
- Vol.3: [タイトル]
- Vol.4: [タイトル]
- Vol.5: [タイトル]
--- [SERIES MASTER SHEET: END] ---
`;
